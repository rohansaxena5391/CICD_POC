name: Deploy ServiceNow App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SN_INSTANCE: ${{ secrets.SN_INSTANCE_URL }}
      SN_USERNAME: ${{ secrets.SN_USERNAME }}
      SN_PASSWORD: ${{ secrets.SN_PASSWORD }}
      APP_SCOPE: x_1761963_ci_cd_pi
      BRANCH_NAME: ${{ github.ref_name }}

    steps:
      - name: Apply Remote Changes
        run: |
          curl -X POST "$SN_INSTANCE/api/sn_cicd/apply_changes" \
            --user "$SN_USERNAME:$SN_PASSWORD" \
            --header "Content-Type: application/json" \
            --data '{
              "application_scope": "'"$APP_SCOPE"'",
              "branch_name": "'"$BRANCH_NAME"'"
            }'

      - name: Publish Application
        run: |
          curl -X POST "$SN_INSTANCE/api/sn_cicd/publish" \
            --user "$SN_USERNAME:$SN_PASSWORD" \
            --header "Content-Type: application/json" \
            --data '{
              "application_scope": "'"$APP_SCOPE"'"
            }'

      - name: Install Application
        run: |
          curl -X POST "$SN_INSTANCE/api/sn_cicd/install" \
            --user "$SN_USERNAME:$SN_PASSWORD" \
            --header "Content-Type: application/json" \
            --data '{
              "application_scope": "'"$APP_SCOPE"'"
            }'
